<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Making of a Dashboard - Part 3 | Paul Xu</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="alternate" type="application/rss+xml" href="https://digicosmos86.github.io/datascience-blog/rss.xml" title="Paul Xu RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://digicosmos86.github.io/datascience-blog/feed.atom" title="Paul Xu Atom Feed">
    <link rel="alternate" type="application/json" href="https://digicosmos86.github.io/datascience-blog/feed.json" title="Paul Xu JSON Feed">
    <meta name="description" content="Rendering the visualizations with d3.js.">
    <link rel="preload" href="/datascience-blog/assets/css/0.styles.a8f1b679.css" as="style"><link rel="preload" href="/datascience-blog/assets/js/app.a5d756ca.js" as="script"><link rel="preload" href="/datascience-blog/assets/js/7.02e7f03a.js" as="script"><link rel="preload" href="/datascience-blog/assets/js/3.cedd6dfe.js" as="script"><link rel="preload" href="/datascience-blog/assets/js/20.ea7dd686.js" as="script"><link rel="preload" href="/datascience-blog/assets/js/5.e3e46663.js" as="script"><link rel="preload" href="/datascience-blog/assets/js/8.285985a2.js" as="script"><link rel="prefetch" href="/datascience-blog/assets/js/10.1974e434.js"><link rel="prefetch" href="/datascience-blog/assets/js/11.6eb45fe3.js"><link rel="prefetch" href="/datascience-blog/assets/js/12.9025996a.js"><link rel="prefetch" href="/datascience-blog/assets/js/13.59414105.js"><link rel="prefetch" href="/datascience-blog/assets/js/14.a49ceca5.js"><link rel="prefetch" href="/datascience-blog/assets/js/15.a27d6d12.js"><link rel="prefetch" href="/datascience-blog/assets/js/16.a00b7005.js"><link rel="prefetch" href="/datascience-blog/assets/js/17.4f97b494.js"><link rel="prefetch" href="/datascience-blog/assets/js/18.a66e2624.js"><link rel="prefetch" href="/datascience-blog/assets/js/19.3c124cdf.js"><link rel="prefetch" href="/datascience-blog/assets/js/21.fa275f59.js"><link rel="prefetch" href="/datascience-blog/assets/js/22.1085a160.js"><link rel="prefetch" href="/datascience-blog/assets/js/4.bb12d645.js"><link rel="prefetch" href="/datascience-blog/assets/js/6.68ba1863.js"><link rel="prefetch" href="/datascience-blog/assets/js/9.e3cd42b9.js"><link rel="prefetch" href="/datascience-blog/assets/js/vuejs-paginate.64cf95e6.js">
    <link rel="stylesheet" href="/datascience-blog/assets/css/0.styles.a8f1b679.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><nav class="navbar navbar-expand-md navbar-light bg-white fixed-top"><div class="container"><a href="/datascience-blog/" class="navbar-brand"><img src="/datascience-blog/assets/img/logo.svg">
            Paul Xu
          </a> <button type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"><span class="navbar-toggler-icon"></span></button> <div id="navbarsExampleDefault" class="collapse navbar-collapse"><ul class="navbar-nav ml-auto"><li class="nav-item"><a href="/datascience-blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/datascience-blog/tag/" class="nav-link">Tags</a></li> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="./rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></ul></div></div></nav></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/datascience-blog/" class="mobile-home-link navbar-brand"><img src="/datascience-blog/assets/img/logo.svg"> Paul Xu
      </a> <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/datascience-blog/">Blog</a></li><li class="mobile-nav-item"><a href="/datascience-blog/tag/">Tags</a></li> <li class="mobile-nav-item"><a href="./rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="container wrapmain"><div id="vuepress-theme-blog__post-layout" data-v-1c1f12bb><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content" data-v-1c1f12bb><div class="row justify-content-center" data-v-1c1f12bb><div class="col-md-8" data-v-1c1f12bb><header data-v-1c1f12bb><span class="text-muted" data-v-1c1f12bb><div class="post-meta" data-v-1c1f12bb><!----> <div class="post-meta-date"><time pubdate itemprop="datePublished" datetime="2020-07-11T00:00:00.000Z">
Sat, Jul 11 2020
</time></div> <!----></div></span> <h1 itemprop="name headline" class="article-head mt-3" data-v-1c1f12bb>
  The Making of a Dashboard - Part 3
  </h1> <p class="lead" data-v-1c1f12bb>Rendering the visualizations with d3.js.</p> <div data-v-1c1f12bb><span><div class="d-flex align-items-center"><a class="profile-avatar"><img src="/datascience-blog/assets/img/myAvatar.png" alt="Paul Xu" class="avatar-image"></a> <div><span>Paul Xu</span>  
      <a href="https://thepolicylab.brown.edu/team/paul-xu/" target="_blank" rel="noopener noreferrer" class="external btn btn-sm btn-outline-dark">Follow</a></div></div></span><span><div class="d-flex align-items-center"><a class="profile-avatar"><!----></a> <!----></div></span></div></header></div></div> <div class="row justify-content-center text-center mt-4 mb-40" data-v-1c1f12bb><div class="col-md-9" data-v-1c1f12bb><img src="/datascience-blog/assets/img/stackedbar1.png" class="featuredimg" data-v-1c1f12bb></div></div> <div class="row justify-content-center" data-v-1c1f12bb><div class="col-md-8" data-v-1c1f12bb><div itemprop="articleBody" class="content__default" data-v-1c1f12bb><p>In this post, we will cover the details in creating the data visualizations used in <a href="https://thepolicylab.github.io/UW-211" target="_blank" rel="noopener noreferrer">the United Way Rhode Island 211 Dashboard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to reveal patterns in 211 calls. <a href="https://digicosmos86.github.io/datascience-blog/2020/07/10/the-making-of-a-dashboard/" target="_blank" rel="noopener noreferrer">The previous post<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> described in detail the overall architecture of the app and how data is persisted as state in the Vue app. This post focuses more on the gotchas using d3.js to create interactive data visualizations.</p> <p>Links to other posts in the series:</p> <ul><li><a href="/datascience-blog/_posts/the-making-of-a-dashboard-part1.html">Part 1. Background and Decisions on Tech Stack</a></li> <li><a href="/datascience-blog/_posts/the-making-of-a-dashboard-part2.html">Part 2. Building the Skeleton of the App with Vue.js</a></li> <li><a href="/datascience-blog/_posts/the-making-of-a-dashboard-part4.html">Part 4. UI/UX Refinements from Stakeholder Feedback</a></li></ul> <h2 id="general-design-patterns"><a href="#general-design-patterns" class="header-anchor">#</a> General Design Patterns</h2> <p>Each of the visualizations lives within a Vue component. The overall structure of the component looks like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      filteredData<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// stores the result of the filterData method</span>
      
      <span class="token comment">// persist a chart object with an updateChart method that can be called</span>
      <span class="token comment">// when the filter is updated.</span>
      chart<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    rawData<span class="token operator">:</span> Object<span class="token punctuation">,</span>
    filter<span class="token operator">:</span> Object
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// inititalizes the chart and returns a chart object with an updateChart method</span>
    <span class="token function">initChart</span><span class="token punctuation">(</span><span class="token parameter">filter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// filters rawData and returns filteredData in the components state</span>
    <span class="token function">filterData</span><span class="token punctuation">(</span><span class="token parameter">filteredData<span class="token punctuation">,</span> filter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// filters the data and creates the chart when the component is being created</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filteredData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterData</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chart <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initChart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filteredData<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    filter<span class="token operator">:</span> <span class="token punctuation">{</span>
      deep<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// create a &quot;deep watcher&quot; that monitors each element of the object</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">newFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>filteredData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterData</span><span class="token punctuation">(</span>newFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">updateChart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filteredData<span class="token punctuation">,</span> newFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The above code snippet shows that the component receives as props the 211 data loaded from a <code>.csv</code> file and a filter objects that contains all of the parameters of the filter. Whenever the component is created (i.e. when the <code>created()</code> lifecycle method is called), the <code>filterData</code> method is called and the result is stored in the component's state. Then the <code>initChart()</code> method is called, returning in a chart object, which is also saved to the component's state. This chart objects itself has an <code>updateChart</code> method, which can be used to update the chart. This follows the d3.js design pattern described <a href="https://medium.com/d3js-tutorials/a-d3-js-design-pattern-16a6503dc86f" target="_blank" rel="noopener noreferrer">in this article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to keep d3 code centralized in the Vue component.</p> <p>Each component also has a deep <code>watcher</code> that watches the filter props. Whenever the filter changes, its handler will call the <code>filterData</code> method again, and then call the <code>updateChart</code> method of the <code>chart</code> object persisted in the state to update the chart.</p> <h2 id="let-s-make-the-map"><a href="#let-s-make-the-map" class="header-anchor">#</a> Let's Make the Map!</h2> <p>Making a map (choropleth) with d3.js is a widely covered subject. There are many tutorials avaiable that walks you through how to create a map using <code>geojson</code>/<code>topojson</code> in d3. For example, this <a href="https://observablehq.com/@d3/choropleth" target="_blank" rel="noopener noreferrer">Observable notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by d3's creator Mike Bostock contains code for creating choropleths in d3 v5. <a href="https://datawanderings.com/2018/10/28/making-a-map-in-d3-js-v-5/" target="_blank" rel="noopener noreferrer">This article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is also a great tutorial for creating such maps. What I want to cover in this section is a few things that got me stuck for hours.</p> <h3 id="_1-finding-the-correct-geojson-topojson-for-the-base-map"><a href="#_1-finding-the-correct-geojson-topojson-for-the-base-map" class="header-anchor">#</a> 1. Finding the correct <code>geojson/topojson</code> for the base map</h3> <p>Typically you should have no difficulties finding a <code>geojson</code>/<code>topojson</code> file that contains the correct border outlines for the geographical information that you want to plot. However, these files are made to be very precise and tend to be too big for a project like this. The <code>geojson</code> file that I got at first from the <a href="http://www.rigis.org/datasets/municipalities-1997" target="_blank" rel="noopener noreferrer">RI GIS website<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> was over 6MB. I tried to use <a href="https://mapshaper.org/" target="_blank" rel="noopener noreferrer">MapShaper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to reduce the file size but d3 had problems reading the files it produced. I eventually found a <code>topojson</code> file that was small enough. So, you might need to spend some time finding the right files for the base map, especailly if you are focusing on a state or a smaller region.</p> <h3 id="_2-using-the-correct-projection"><a href="#_2-using-the-correct-projection" class="header-anchor">#</a> 2. Using the correct projection</h3> <p>We will need a projection function that projects geographic coordinates to planar coordinates that can be used to draw SVG paths with d3.js. If we were creating a map of the United States, then the <code>AlbersUSA</code> projection comes in quite handy. In this project, I used the <code>mercator</code> projection, which had to be scaled over 30,000 times with numerous trials and errors to make the map look the way it is. I welcome any comment/feedback on other ways to project the map of states that does not require as much correction.</p> <h3 id="_3-the-infamous-maup-problem"><a href="#_3-the-infamous-maup-problem" class="header-anchor">#</a> 3. The infamous MAUP problem</h3> <p>Another problem that I encontered when mapping the 211 call data is this so-called Modifiable area unit problem (MAUP), which, in this context, means that the number of calls plotted on a map is a reflection of that area's population density. In this case, since Providence is RI's only population center, naturally many more 211 calls would originate from Providence, which results in a map with only Providence highlighted. I modified the color scale to reflect the number of calls per 1000 capita to preserve some interpretability. I also welcome any suggestions/comments on other ways to produce maps that are less biased by population density.</p> <h2 id="stacked-area-chart-with-smooth-transitions"><a href="#stacked-area-chart-with-smooth-transitions" class="header-anchor">#</a> Stacked Area Chart with Smooth Transitions</h2> <p>As with the Map, we are not going to be concerned with how to create a stacked area chart in d3.js. <a href="https://www.d3-graph-gallery.com/graph/stackedarea_template.html" target="_blank" rel="noopener noreferrer">This great tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> covers this topic thoroughly and nicely. Also, I would recommend that you use a library such as <code>vega</code>, <code>vega-lite</code>, <code>chart.js</code>, <code>c3.js</code>, <code>apex charts</code> and any other JavaScript charting library to create it, because while creating the area chart itself is not difficult, creating informative tooltips can be quite involved. Here, we are using plain d3 for two reasons. First, there are too many categories in the data and we would like to only display major categories when all categories are shown. That means we will need to customize the legend a little bit. Second, we also want to create smooth transition animations when the data changes. We cannot achieve such deep customization with a library.  The rest of this section will focus on how we created the smooth transition animations for the stacked area chart shown below. We will also touch upon some gotchas in data wrangling in the browser with d3, and how to display time series data properly with time scales.</p> <p><img src="/datascience-blog/assets/img/stackbarchart.gif" alt=""></p> <h3 id="creating-smooth-transitions"><a href="#creating-smooth-transitions" class="header-anchor">#</a> Creating smooth transitions</h3> <p>d3 provides a <code>transition</code> function that allows smooth transition animations when the underlying data of the visualizations changes. <a href="https://observablehq.com/@d3/streamgraph-transitions" target="_blank" rel="noopener noreferrer">This article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> shows a really cool transition with a streamgraph. With the <code>transition()</code> and <code>delay()</code> functions, it is very easy to create such animations. However, the transition breaks down when the number of data points on the x-axis changes. For example, when a user wants to see the data from last month instead of last week. The reason is that when there is no changes in the number of data points on the x-axis, d3 can figure out that each data point is only going up and down and interpolate the intermediate points between the start and end positions for each data point. However, when this prerequisite no longer holds, d3 will have trouble interpolating the intermediate position for the shapes to change, resulting in unwieldy transition animations that look weird.</p> <p>The solution to this is to tell d3 to hold the points on both ends of the area charts, these points can only go up and down. Then the rest of the algorithm will figure out how to interpolate the positions of other points, so that the transition looks better. We used the <code>d3-interpolate-path</code> library for this task. To use this library, first install it with npm.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -s d3-interpolate-path
</code></pre></div><p>Then, import the library to the code for stacked area chart with:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> interpolatePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;d3-interpolate-path&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>Next, when the data changes, pass the interpolation function to</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>stacks<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">enter</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    enter
      <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;area&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;fill&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">color</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> area<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;opacity&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span> handleMouseOver<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;mouseout&quot;</span><span class="token punctuation">,</span> handleMouseOut<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">enter</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> enter<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;opacity&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    update
      <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;fill&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">color</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        update
          <span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">duration</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;opactiy&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">attrTween</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> previous <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token function">area</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">interpolatePath</span><span class="token punctuation">(</span>previous<span class="token punctuation">,</span> current<span class="token punctuation">,</span> excludeSegment<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">exit</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> exit<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">duration</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;opacity&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">excludeSegment</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token punctuation">.</span>x <span class="token operator">===</span> b<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The above code uses d3 v5's <code>selection.join()</code> function to update the rendered chart using d3's enter, update, and exit pattern. <a href="https://observablehq.com/@d3/selection-join" target="_blank" rel="noopener noreferrer">This Observable notebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> explains in detail how it works, but the TL;DR version it is, it accepts 3 functions that describes what to do with new data points (enter), what to do with data points that have changed (update), and what to do with data points that no longer exists (exit). <code>interpolatePath</code> was used in the callback that handles updates. We first use <code>selection.attrTween()</code> that accepts a function that describes how the tweening between the changes in an specific attribute of a selection should happen. The <code>excludeSegment</code> function defines that as long as the line segment lies on both ends of the area (any two points <code>a</code>, <code>b</code> whose coordinates satisfy <code>a.x === b.x</code>), then these points should be excluded in the interpolation of the transition, resulting in smooth transitions even when the numbers of data points change.</p> <h3 id="wrangling-data-in-d3"><a href="#wrangling-data-in-d3" class="header-anchor">#</a> Wrangling data in d3</h3> <p>Since we are not using any backend, any data wrangling such as group aggregations are done with d3. Although d3 provides lots of functions for performing such operations, there is not a data structure such as <code>pandas.DataFrame</code> in Python or <code>data.frame</code> in R that easily and efficiently does group aggregations. In this context, we want to aggregate for each day, in each category, how many calls were received. This would have been a simple call to <code>df.groupby().sum()</code> in Python or similar functions in <code>dplyr</code> in R. d3 provides a <code>d3.nest()</code> function for us to do the same thing, but it's not very straightforward:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> nestedData <span class="token operator">=</span> d3
  <span class="token punctuation">.</span><span class="token function">nest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>date<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sortKeys</span><span class="token punctuation">(</span>d3<span class="token punctuation">.</span>ascending<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sortKeys</span><span class="token punctuation">(</span>d3<span class="token punctuation">.</span>ascending<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token parameter">leaf</span> <span class="token operator">=&gt;</span> d3<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> <span class="token parameter">d</span> <span class="token operator">=&gt;</span> <span class="token operator">+</span>d<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="http://bl.ocks.org/phoebebright/raw/3176159/" target="_blank" rel="noopener noreferrer">This article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> provides a few good examples on how nesting works in d3.js.  to build the stacked area chart, we created a two-layer nest, with <code>date</code> and <code>type</code> as keys. This step is similar to <code>df.groupby(['date', 'type'])</code> in pandas in Python. Then, <code>nest()</code> provides a <code>rollup</code> function to collect results on leaves in this data structure, which are arrays of objects that have the same <code>date</code>s and <code>type</code>s . Here, we use <code>d3.sum()</code> to sum up the number of calls (stored in <code>count</code>). Then we use <code>d3.nest().map()</code> on the raw data to return a <code>map</code> data structure. Lastly, we use the <code>entries()</code> function of the JavaScript <code>map</code> data structure to obtain an array of counts for each type of calls on each day. This array can then be passed to d3's <code>d3.stack()</code> function to create a stacked data structure that can be used to create the stacked area chart.</p> <h3 id="to-display-dates-correctly"><a href="#to-display-dates-correctly" class="header-anchor">#</a> To display dates correctly</h3> <p>Unlike Python, JavaScript does not have a dedicated type for dates. The <code>Date()</code> object actually stores both date and time as an integer, and it can behave slightly unexpectedly:</p> <div class="language- extra-class"><pre><code>&gt; new Date(&quot;2020-06-01&quot;)
2020-06-01T00:00:00.000Z
&gt; new Date(&quot;2020/06/01&quot;)
2020-06-01T04:00:00.000Z
</code></pre></div><p>The above code was run in node.js. However, in Chrome, what we got was:</p> <div class="language- extra-class"><pre><code>new Date(&quot;2020-06-01&quot;)
Sun May 31 2020 20:00:00 GMT-0400 (Eastern Daylight Time)
new Date(&quot;2020/06/01&quot;)
Mon Jun 01 2020 00:00:00 GMT-0400 (Eastern Daylight Time)
</code></pre></div><p>This might cause some unexpected bugs. My recommendation is to use <code>moment.js</code> for date operations whenever possible, and use UTC time for dates. This means using <code>d3.scaleUtc()</code> for the x-axis for the stacked bar chart. Otherwise, each data points will be rendered slightly before the ticks for each date, since a string like <code>2020-06-01</code> is seen as 8pm of the previous day locally (Eastern Daylight Time).</p> <h2 id="next-up"><a href="#next-up" class="header-anchor">#</a> Next up</h2> <p>In this post we discussed in details the designs that make d3 and Vue work in harmony and the gotchas in building the data visualizations. Based on these ideas, we created a first prototype for the UWRI team and internally for the rest of The Policy Lab for their feedback. The next post will discuss the UI/UX improvement we made to the dashboard based on the feedback that we received.</p> <p><a href="/datascience-blog/_posts/the-making-of-a-dashboard-part4.html">Part 4. UI/UX Refinements from Stakeholder Feedback</a></p></div> <div class="post-meta" data-v-1c1f12bb><!----> <!----> <div itemprop="keywords" class="card-subheading post-meta-tags"><a href="/datascience-blog/tag/data visualization" data-v-43160e8a> data visualization </a><a href="/datascience-blog/tag/dashboard" data-v-43160e8a> dashboard </a><a href="/datascience-blog/tag/Vue.js" data-v-43160e8a> Vue.js </a><a href="/datascience-blog/tag/d3.js" data-v-43160e8a> d3.js </a><a href="/datascience-blog/tag/javascript" data-v-43160e8a> javascript </a><a href="/datascience-blog/tag/animation" data-v-43160e8a> animation </a><a href="/datascience-blog/tag/transition" data-v-43160e8a> transition </a></div></div></div></div></article> <div class="row justify-content-center" data-v-1c1f12bb><div class="col-md-9" data-v-1c1f12bb><form class="newsletter" data-v-1c1f12bb><div class="newsletter__wrap"><div class="newsletter__title">Newsletter</div> <div class="newsletter__content">Subscribe to get my latest content. No spam.</div> <div class="newsletter__fields"><input type="email" name="email" aria-label="Email" placeholder="Email" required="required" autocapitalize="off" autocorrect="off" data-cy="email" value="" class="newsletter__input"> <button type="submit" data-cy="submit" class="newsletter__button">
        Subscribe
      </button></div></div></form> <!----></div></div> <div class="sticker vuepress-toc" data-v-1c1f12bb><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#general-design-patterns" title="General Design Patterns">General Design Patterns</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#let-s-make-the-map" title="Let's Make the Map!">Let's Make the Map!</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-finding-the-correct-geojson-topojson-for-the-base-map" title="1. Finding the correct geojson/topojson for the base map">1. Finding the correct geojson/topojson for the base map</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-using-the-correct-projection" title="2. Using the correct projection">2. Using the correct projection</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-the-infamous-maup-problem" title="3. The infamous MAUP problem">3. The infamous MAUP problem</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#stacked-area-chart-with-smooth-transitions" title="Stacked Area Chart with Smooth Transitions">Stacked Area Chart with Smooth Transitions</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#creating-smooth-transitions" title="Creating smooth transitions">Creating smooth transitions</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#wrangling-data-in-d3" title="Wrangling data in d3">Wrangling data in d3</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#to-display-dates-correctly" title="To display dates correctly">To display dates correctly</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#next-up" title="Next up">Next up</a></div></div></div></div> <footer class="themefooter"><div class="container"><div class="row justify-content-between"><div class="col"><a href="/"><img src="/datascience-blog/assets/img/logo-white.png" class="logofooter"></a> <div class="footer-subtitle">
          A Data Science Blog by Paul Xu
        </div></div> <div class="col text-right"><ul class="list-unstyled"><li class="contact-item"><a href="https://github.com/wowthemesnet/mediumish-vuepress-blog-theme" target="_blank" rel="noopener noreferrer" class="external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
              
            </a></li><li class="contact-item"><a href="https://www.linkedin.com/in/paulxubc/" target="_blank" rel="noopener noreferrer" class="external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
              
            </a></li><li class="contact-item"><a href="https://twitter.com/paulxu_bc" target="_blank" rel="noopener noreferrer" class="external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
              
            </a></li><li class="contact-item"><a href="https://thepolicylab.brown.edu/team/paul-xu/" target="_blank" rel="noopener noreferrer" class="external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
              
            </a></li></ul> <ul class="list-unstyled"><li class="copyright-item"><a href="/datascience-blog/2020/07/11/the-making-of-a-dashboard-part3/.html#">Copyright © Paul Xu 2020.</a></li><li class="copyright-item"><a href="https://bootstrapstarter.com/bootstrap-templates/vuepress-theme-mediumish/" target="_blank" rel="noopener noreferrer" class="external">Made with Mediumish - free Vuepress theme</a></li></ul></div></div></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/datascience-blog/assets/js/app.a5d756ca.js" defer></script><script src="/datascience-blog/assets/js/7.02e7f03a.js" defer></script><script src="/datascience-blog/assets/js/3.cedd6dfe.js" defer></script><script src="/datascience-blog/assets/js/20.ea7dd686.js" defer></script><script src="/datascience-blog/assets/js/5.e3e46663.js" defer></script><script src="/datascience-blog/assets/js/8.285985a2.js" defer></script>
  </body>
</html>
